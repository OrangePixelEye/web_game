<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        canvas{
            position: absolute;
            top: 0px;
            bottom: 0px;
            left: 0px;
            right: 0px;
            margin: auto;
        }
    </style>
    
</head>
<body>
    <script>
        let bordas, contexto, ALTURA, LARGURA,  frames = 0, max_pulos = 2;
        let Key = {
            LEFT:   37,
            UP:     38,
            RIGHT:  39,
            DOWN:   40
        };

        chao = {
            y: 550,
            altura_chao: 50,
            cor: "#e8da78",

            desenhochao: function(){
                contexto.fillStyle = this.cor;
                contexto.fillRect(0, this.y, LARGURA, this.altura_chao);
            },
        },

        bloco = {
            x: 50,
            y: 0,
            altura: 50,
            largura: 50,
            cor_bloco:"#FA43D6",
            gravidade: 1.6,
            velocidade:0,
            velocidade_x: 0,
            forca_x : 8,
            forca_pulo:23.6,
            qtd_pulos: 0,

            atualizaBloco: function(){
                this.velocidade += this.gravidade
                this.x += this.velocidade_x
                this.y += this.velocidade
                if(this.y > chao.y - this.altura){
                    this.y = chao.y - this.altura
                    this.qtd_pulos = 0
                }
            },
            move : function(direita)
            {
                this.velocidade_x = this.forca_x * (direita == 0 ? -1 : 1)
            },
            para : function(){
                this.velocidade_x = 0
            },
            pula : function()
            {
                if(this.qtd_pulos < max_pulos){
                    this.velocidade = -this.forca_pulo
                    this.qtd_pulos++
                }
            },
            desenhaBloco:function()
            {
                contexto.fillStyle = this.cor_bloco
                contexto.fillRect(this.x,this.y, this.altura, this.largura)
            }
        },

        obstaculos = {
            _obs : [],
            cores: ["#ba5750","#8ab75b","#df50a0", "#1a5850", "#65a750"],

            tempo_insere : 0,
            insere : function()
            {
                this._obs.push({
                    x: 60 + Math.floor(500 * Math.random()),
                    y : 0,
                    velocidade_x : 0,
                    velocidade : 0,
                    largura: 30 + Math.floor(20 * Math.random()),
                    altura : 30 + Math.floor(120 * Math.random()),
                    cor : this.cores[Math.floor(5 * Math.random())],
                     
                });

                this.tempo_insere = 30 + Math.floor(21 * Math.random())
                

            },
            atualiza : function(){
                for(var i = 0, tam = this._obs.length; i < tam; i++)
                {
                    var obs = this._obs[i]

                    obs.velocidade_x -= 0.1
                    obs.x += obs.velocidade_x

                    obs.velocidade += bloco.gravidade
                    obs.y += obs.velocidade
                    if(obs.y > chao.y - obs.altura){
                        obs.y = chao.y - obs.altura
                    }
                    if(colidiu(obs, bloco)) console.log("Colidiu")
                    if(obs.x < 0) this._obs.pop(obs)
                    
                    
                }
                
            },
            desenhar : function()
            {
                for(var i = 0, tam = this._obs.length; i < tam; i++)
                {
                    var obs = this._obs[i]
                    contexto.fillStyle = obs.cor
                    //chao.y - obs.altura
                    contexto.fillRect(obs.x, obs.y, obs.largura, obs.altura)
                }
                
            }
        }
        function colidiu(a, b) {
            return !(
                ((a.y + a.altura) < (b.y)) ||
                (a.y > (b.y + b.altura)) ||
                ((a.x + a.largura) < b.x) ||
                (a.x > (b.x + b.largura))
            );
        }

        function clicar(){
            bloco.pula()
        }

        function input_teclado(evt){
            if (!evt) {evt = window.event;} // for old IE compatible
            var keycode = evt.keyCode || evt.which; // also for cross-browser compatible

            var info = document.getElementById("info");
            switch (keycode) {
                case Key.LEFT:
                    bloco.move(false);
                    break;
                case Key.UP:
                    bloco.pula()
                    break;
                case Key.RIGHT:
                    bloco.move(true);
                    break;
                default:
                    break;
            }
        }

        function solta(){
            bloco.para()
        }

        function _addEventListener(evt, element, fn) {
            if (window.addEventListener) {
                element.addEventListener(evt, fn, false);
            }
            else {
                element.attachEvent('on'+evt, fn);
            }
        }

        function main(){
            obstaculos.insere()
            ALTURA = window.innerHeight;
            LARGURA = window.innerWidth;
            
            if (LARGURA >= 500){
                LARGURA = 600
                ALTURA = 600
            }

            canvas = document.createElement("canvas");
            canvas.width = LARGURA
            canvas.height = ALTURA
            canvas.style.border = "1px solid #000";

            contexto = canvas.getContext("2d")
            document.body.appendChild(canvas)
            document.addEventListener("mousedown", clicar)

            //document.addEventListener("key")
            //keypress
            document.addEventListener("keyup", solta)
            _addEventListener('keydown', document, input_teclado)
            //element.addEventListener("keydown", document, input_teclado);
            
            rodar()
        }

        function rodar(){
            atualizar()
            desenhar()
            
            contexto.fillStyle = "#238BF2"
            contexto.fillRect(0, 0, 100, ALTURA)

            contexto.fillStyle =  "#101EF2"
            contexto.fillRect(100, 0, 500, ALTURA)
            
            contexto.fillStyle =  "#133EF2"
            contexto.fillRect(500, 0, LARGURA, ALTURA)

            window.requestAnimationFrame(rodar)
            desenhar()
            //input_teclado()
        }
        
        function atualizar(){
            frames++
            
            obstaculos.atualiza()
            bloco.atualizaBloco()
        }
        
        function desenhar(){
            chao.desenhochao()
            
            bloco.desenhaBloco()
            obstaculos.desenhar()
        }
        
        main()
    </script>
</body>
</html>